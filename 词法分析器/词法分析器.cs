// 引入System命名空间，提供基础功能
using System;
// 引入泛型集合命名空间，用于存储Token列表
using System.Collections.Generic;
// 引入正则表达式命名空间
using System.Text.RegularExpressions;
namespace CnToCs.词法分析器
{
    public enum 词法单元类型
    {
        接口,       // "定义接口"interface
        类,         // "定义类"class
        继承,       // "继承" :
        构造函数,   // "构造函数"
        方法,       // "方法"
        虚方法,     // "虚方法"virtual 使用override重写
        重写方法,   // "重写方法"override
        抽象方法,   // "抽象方法"abstract
        字符串,     // "字符串"string
        整数,       // "整数"int
        小数,       // "小数"double
        布尔值,     // "布尔值"bool
        引用,       // "引用"ref
        对象,       // "对象"object
        可为空,     // "可为空"
        公开,       // "公开"public
        私有,       // "私有"private
        保护,       // "保护"protected
        只读,       // "只读"readonly
        静态,       // "静态"static
        无返回值,   // "无返回值"void
        标识符,           // 标识符（中文名称）
        左大括号,         // '{'
        右大括号,         // '}'
        左圆括号,         // '('
        右圆括号,         // ')'
        左尖括号,         // '<'
        右尖括号,         // '>'
        冒号,             // ':'
        分号,             // ';'
        逗号,             // ','
        点号,             // '.'
        等号,             // '='
        加号,             // '+'
        减号,             // '-'
        乘号,             // '*'
        除号,             // '/'
        双等号,           // '=='
        不等号,           // '!='
        逻辑与,           // '&&'
        逻辑或,           // '||'
        逻辑非,           // '!'
        字符串字面量,     // "字符串内容"
        数字字面量,       // 0-9数字
        返回,             // "返回"
        如果,             // "如果"
        否则,             // "否则"
        新,               // "新"
        空,               // "空"
        真,               // "真"
        假,               // "假"
    }
    /// <summary>
    /// 词法单元类：词法分析得到的单个Token
    /// </summary>
    public class 词法单元
    {
        //token 类型
       public 词法单元类型 类型{get;}
       //单个token
       public string 值{get;}
         public 词法单元(词法单元类型 类型,string 值)
         {
                this.类型=类型;
                this.值=值;
         }
    }
    public class 词法分析器
    {
        private readonly string 输入文本;
        private int 当前读取位置;
        public 词法分析器(string 输入文本)
         {
              this.输入文本=输入文本;
              this.当前读取位置=0;
         }
        private string 截取字符串(string 截取的字符串,int 起始位置,int 结束位置)
        {
        return 截取的字符串.Substring(起始位置,结束位置-起始位置);
        }

        private bool 是否为空字符(char 检测字符)
        {
        return char.IsWhiteSpace(检测字符);
        }

        private bool 是否为关键词(string 关键词,词法单元类型 类型,ref List<词法单元> 词法单元列表)
        {
            //判断当前位置的文本是否与关键词匹配
            if (this.当前读取位置+关键词.Length <= 输入文本.Length && 截取字符串(this.输入文本,this.当前读取位置,this.当前读取位置+关键词.Length)==关键词)
            {
                词法单元列表.Add(new 词法单元(类型,关键词));
                //移动当前读取位置到指向为关键词之后的位置
                this.当前读取位置+=关键词.Length;

                return true;
            }
            else
            {
                return false;
            }
        }
        //该方法由AI辅助完成
        private bool 是否为中文字符(char 字符)
        {
            return 字符 >= 0x4E00 && 字符 <= 0x9FFF;
        }
        //该方法由AI辅助完成
        private bool 是否为字母字符(char 字符)
        {
            return char.IsLetter(字符);
        }
        private bool 是否为标识符(ref List<词法单元> 词法单元列表)
        {
            //判断当前字符是否为中文字符或字母字符或下划线
            if (是否为中文字符(输入文本[当前读取位置])||是否为字母字符(输入文本[当前读取位置])||输入文本[当前读取位置]=='_')
            {
                int 当前位置 = this.当前读取位置;
                //连续读取所有中文字符或英文标识符字符,直到遇到非中文字符、非字母字符、非数字字符或非下划线字符
                while (当前读取位置 < 输入文本.Length &&(是否为中文字符(输入文本[当前读取位置])||是否为字母字符(输入文本[当前读取位置]) ||char.IsDigit(输入文本[当前读取位置]) ||输入文本[当前读取位置] == '_'))
                {
                    当前读取位置++;
                }
                // 截取标识符字符串
                string 标识符 = 截取字符串(输入文本,当前位置,this.当前读取位置);
                //添加标识符token;
                词法单元列表.Add(new 词法单元(词法单元类型.标识符,标识符));
                return true;
            }
            else
            {
                return false;
            }
        }
        private bool 是否为注释()
        {
            //匹配符号"/"
            if (this.当前读取位置 + 1 < this.输入文本.Length &&this.输入文本[this.当前读取位置] == '/' &&this.输入文本[this.当前读取位置 + 1] == '/')
            {
                //跳过注释//符号
                this.当前读取位置+=2;

                // 跳过直到行尾的所有字符
                while (this.当前读取位置 < this.输入文本.Length && this.输入文本[this.当前读取位置] != '\n' && this.输入文本[this.当前读取位置] != '\r')
                {
                    this.当前读取位置++;
                }
                
                return true;
            }
            return false;
        }
        private bool 是否为符号(char 符号, 词法单元类型 类型, ref List<词法单元> 词法单元列表)
        {
            if (this.输入文本[this.当前读取位置] == 符号)
            {
                // 添加符号Token
                this.当前读取位置++;
                词法单元列表.Add(new 词法单元(类型, 符号.ToString()));
                return true;
            }
            return false;
        }

        private bool 是否为双字符符号(string 符号, 词法单元类型 类型, ref List<词法单元> 词法单元列表)
        {
            if (this.当前读取位置 + 符号.Length <= 输入文本.Length &&
                截取字符串(this.输入文本, this.当前读取位置, this.当前读取位置 + 符号.Length) == 符号)
            {
                // 添加符号Token
                this.当前读取位置 += 符号.Length;
                词法单元列表.Add(new 词法单元(类型, 符号));
                return true;
            }
            return false;
        }

        private bool 是否为字符串字面量(ref List<词法单元> 词法单元列表)
        {
            if (this.输入文本[this.当前读取位置] == '"')
            {
                // 跳过开始的双引号
                this.当前读取位置++;
                int 字符串开始位置 = this.当前读取位置;
                
                // 查找结束的双引号
                while (this.当前读取位置 < this.输入文本.Length && this.输入文本[this.当前读取位置] != '"')
                {
                    // 处理转义字符
                    if (this.输入文本[this.当前读取位置] == '\\' && this.当前读取位置 + 1 < this.输入文本.Length)
                    {
                        this.当前读取位置 += 2; // 跳过转义字符和被转义的字符
                    }
                    else
                    {
                        this.当前读取位置++;
                    }
                }
                
                if (this.当前读取位置 >= this.输入文本.Length)
                {
                    throw new Exception("字符串字面量未正确结束，缺少结束的双引号");
                }
                
                // 截取字符串内容（不包括双引号）
                string 字符串内容 = 截取字符串(this.输入文本, 字符串开始位置, this.当前读取位置);
                
                // 跳过结束的双引号
                this.当前读取位置++;
                
                // 添加字符串字面量Token
                词法单元列表.Add(new 词法单元(词法单元类型.字符串字面量, 字符串内容));
                return true;
            }
            return false;
        }

        private bool 是否为数字字面量(ref List<词法单元> 词法单元列表)
        {
            if (char.IsDigit(this.输入文本[this.当前读取位置]))
            {
                int 数字开始位置 = this.当前读取位置;
                bool 有小数点 = false;
                
                // 读取整数部分
                while (this.当前读取位置 < this.输入文本.Length && char.IsDigit(this.输入文本[this.当前读取位置]))
                {
                    this.当前读取位置++;
                }
                
                // 检查是否有小数部分
                if (this.当前读取位置 < this.输入文本.Length && this.输入文本[this.当前读取位置] == '.')
                {
                    有小数点 = true;
                    this.当前读取位置++; // 跳过小数点
                    
                    // 读取小数部分
                    if (this.当前读取位置 < this.输入文本.Length && char.IsDigit(this.输入文本[this.当前读取位置]))
                    {
                        while (this.当前读取位置 < this.输入文本.Length && char.IsDigit(this.输入文本[this.当前读取位置]))
                        {
                            this.当前读取位置++;
                        }
                    }
                    else
                    {
                        throw new Exception("数字格式错误：小数点后必须有数字");
                    }
                }
                
                // 截取数字字符串
                string 数字字符串 = 截取字符串(this.输入文本, 数字开始位置, this.当前读取位置);
                
                // 添加数字字面量Token
                词法单元列表.Add(new 词法单元(词法单元类型.数字字面量, 数字字符串));
                return true;
            }
            return false;
        }

        public List<词法单元> 分词()
        {
            // 存储分词结果
            var 词法单元列表 = new List<词法单元>();
            while (this.当前读取位置<输入文本.Length)
            {
                if(是否为空字符(输入文本[当前读取位置]))
                {
                    当前读取位置++;
                    //跳过当前部分循环
                    continue;
                }
                if(
                是否为关键词("接口",词法单元类型.接口,ref 词法单元列表)||
                是否为关键词("类",词法单元类型.类,ref 词法单元列表)||
                是否为关键词("class",词法单元类型.类,ref 词法单元列表)||
                是否为关键词("继承",词法单元类型.继承,ref 词法单元列表)||
                是否为关键词("构造函数",词法单元类型.构造函数,ref 词法单元列表)||
                是否为关键词("方法",词法单元类型.方法,ref 词法单元列表)||
                是否为关键词("虚方法",词法单元类型.虚方法,ref 词法单元列表)||
                是否为关键词("重写方法",词法单元类型.重写方法,ref 词法单元列表)||
                是否为关键词("抽象方法",词法单元类型.抽象方法,ref 词法单元列表)||
                是否为关键词("字符串",词法单元类型.字符串,ref 词法单元列表)||
                是否为关键词("整数",词法单元类型.整数,ref 词法单元列表)||
                是否为关键词("小数",词法单元类型.小数,ref 词法单元列表)||
                是否为关键词("布尔值",词法单元类型.布尔值,ref 词法单元列表)||
                是否为关键词("引用",词法单元类型.引用,ref 词法单元列表)||
                是否为关键词("对象",词法单元类型.对象,ref 词法单元列表)||
                是否为关键词("可为空",词法单元类型.可为空,ref 词法单元列表)||
                是否为关键词("公开",词法单元类型.公开,ref 词法单元列表)||
                是否为关键词("私有",词法单元类型.私有,ref 词法单元列表)||
                是否为关键词("保护",词法单元类型.保护,ref 词法单元列表)||
                是否为关键词("只读",词法单元类型.只读,ref 词法单元列表)||
                是否为关键词("静态",词法单元类型.静态,ref 词法单元列表)||
                是否为关键词("无返回值",词法单元类型.无返回值,ref 词法单元列表)||
                是否为关键词("返回",词法单元类型.返回,ref 词法单元列表)||
                是否为关键词("如果",词法单元类型.如果,ref 词法单元列表)||
                是否为关键词("否则",词法单元类型.否则,ref 词法单元列表)||
                是否为关键词("新",词法单元类型.新,ref 词法单元列表)||
                是否为关键词("空",词法单元类型.空,ref 词法单元列表)||
                是否为关键词("真",词法单元类型.真,ref 词法单元列表)||
                是否为关键词("假",词法单元类型.假,ref 词法单元列表)
                )
                {
                    //跳过当前部分循环
                    continue;
                }
                if(是否为数字字面量(ref 词法单元列表)||是否为字符串字面量(ref 词法单元列表)||是否为标识符(ref 词法单元列表)||是否为注释())
                {
                    //跳过当前部分循环
                    continue;
                }
                // 匹配标点符号（如大括号、冒号、分号等）
                if (是否为符号('{', 词法单元类型.左大括号, ref 词法单元列表) ||
                    是否为符号('}', 词法单元类型.右大括号, ref 词法单元列表) ||
                    是否为符号(':', 词法单元类型.冒号, ref 词法单元列表) ||
                    是否为符号(';', 词法单元类型.分号, ref 词法单元列表) ||
                    是否为符号('(', 词法单元类型.左圆括号, ref 词法单元列表) ||
                    是否为符号(')', 词法单元类型.右圆括号, ref 词法单元列表) ||
                    是否为符号(',', 词法单元类型.逗号, ref 词法单元列表) ||
                    是否为符号('<', 词法单元类型.左尖括号, ref 词法单元列表) ||
                    是否为符号('>', 词法单元类型.右尖括号, ref 词法单元列表) ||
                    是否为符号('=', 词法单元类型.等号, ref 词法单元列表) ||
                    是否为符号('+', 词法单元类型.加号, ref 词法单元列表) ||
                    是否为符号('-', 词法单元类型.减号, ref 词法单元列表) ||
                    是否为符号('*', 词法单元类型.乘号, ref 词法单元列表) ||
                    是否为符号('/', 词法单元类型.除号, ref 词法单元列表) ||
                    是否为符号('.', 词法单元类型.点号, ref 词法单元列表) ||
                    是否为符号('!', 词法单元类型.逻辑非, ref 词法单元列表))
                {
                    continue;
                }
                
                // 匹配双字符运算符
                if (是否为双字符符号("==", 词法单元类型.双等号, ref 词法单元列表) ||
                    是否为双字符符号("!=", 词法单元类型.不等号, ref 词法单元列表) ||
                    是否为双字符符号("&&", 词法单元类型.逻辑与, ref 词法单元列表) ||
                    是否为双字符符号("||", 词法单元类型.逻辑或, ref 词法单元列表))
                {
                    continue;
                }
                // 如果无法匹配任何词法模式则抛出异常
                throw new Exception($"无法识别的字符: {this.输入文本[this.当前读取位置]}");
            }
            return 词法单元列表;
        }
    }
}